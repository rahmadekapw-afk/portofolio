name: Auto Deploy Website

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm install
      - run: npm run build

      - name: Resolve IPv4
        id: resolve_ip
        run: |
          SERVER="${{ secrets.FTP_SERVER }}"
          echo "==== DIAGNOSTICS FOR: $SERVER ===="

          # Check if input is already IPv4
          if [[ $SERVER =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Input is already an IPv4 address."
            echo "ip=$SERVER" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Try multiple ways to get IPv4 only
          echo "Checking A records (IPv4)..."

          # Method 1: dig
          IP=$(dig +short A "$SERVER" | grep -E '^[0-9]+\.' | head -n 1)
          [ ! -z "$IP" ] && echo "Found via dig: $IP"

          # Method 2: nslookup fallback
          if [ -z "$IP" ]; then
            IP=$(nslookup "$SERVER" | grep -A 1 "Name:" | grep "Address:" | grep -E '[0-9]+\.' | awk '{print $2}' | head -n 1)
            [ ! -z "$IP" ] && echo "Found via nslookup: $IP"
          fi

          # Method 3: host fallback
          if [ -z "$IP" ]; then
            IP=$(host -t A "$SERVER" | grep "has address" | awk '{print $4}' | head -n 1)
            [ ! -z "$IP" ] && echo "Found via host: $IP"
          fi

          # Final Check and Output
          if [ -z "$IP" ]; then
            echo "CRITICAL: Could not find any IPv4 (A) record for $SERVER."
            echo "DNS might only return IPv6 (AAAA) or the host is invalid."
            echo "Falling back to original hostname (this will likely fail with IPv6)."
            IP="$SERVER"
          fi

          echo "FINAL SELECTION: $IP"
          echo "ip=$IP" >> $GITHUB_OUTPUT
          echo "==== END DIAGNOSTICS ===="

      - name: Upload to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.resolve_ip.outputs.ip }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: dist/
          server-dir: public_html/
          dangerous-clean-slate: true
